# 브라우저 작동원리

안녕하세요. 
이번 항해톡 시간에 브라우저 작동원리에 대해 
발표를 맡게 된 나유진 입니다.
발표를 시작하겠습니다.



html css 그리고 자바스크립트로 코드를 작성하고,
웹 브라우저는 그 코드를 가지고 웹 페이지를 그려주게 됩니다.
이때 웹 브라우저에서는 어떤 일이 일어날까요?



하나의 웹 페이지를 보여주고 구성하기 위해서
웹 브라우저가 많은 일들을 처리를 한다고 합니다. 
먼저 브라우저의 공통적인 일들을 간단하게 살펴보도록 하겠습니다. 브라우저는 크게 7가지로 구성이 됩니다.
우선 각각의 구조에 대해서 설명 드리겠습니다.



먼저 웹 페이지를 제외하고 상호작용하는 사용자 인터페이스가 있습니다.
예를들어 우리가 인터넷에 들어가면 뒤로가기, 새로고침 버튼 등의 기능들이 있지요? 이처럼 내용이 들어있는 웹 페이지를 제외한 나머지의 기능들이라고 생각해주시면 좋을 것 같습니다. 



그 다음으로는 요청하는 웹페이지를 표시하는 렌더링 엔진이 있습니다. 
여기서는 요청한 Url을 브라우저 엔진에게 받아서 Server에게 요청을 하고 Server로 부터 Url에 해당하는 데이터(HTML과 CSS)를 받아서 파싱 Parsing한 후 렌더링 Rendering하는 역할을 합니다. 이 부분에 대해서는 잠시후에 다시 말씀 드리겠습니다. 



다음으로는 브라우저 엔진인데, 이 부분은 조금 전 말씀드린 유저 인터페이스와 렌더링 엔진을 연결하는 역할을 합니다. 



그리고 네트워크 요청을 수행하는 네트워킹 파트



기본적인 위젯을 그려주는 UI 백엔드 파트가 있습니다.



그리고 data persistance 라는 보조기억장치에다가 내 데이터를 저장하는 파트가 있습니다. 
이 부분은 개발자 도구의 Application 탭에서 확인 하실 수 있습니다.



마지막으로 자바스크립트 코드를 실행하는 인터프리터가 있습니다. 
크롬의 경우에는 V8 엔진을 사용하는데 바로 그 엔진이 인터프리터 입니다. 



이렇게 웹 브라우저의 구조에 대해서 말씀 드렸는데 여기서 저는 렌더링 엔진을 중심으로 한 브라우저 작동원리에 대해 말씀드리고자 합니다. 



먼저 웹 브라우저마다 렌더링 엔진이 조금씩 다르다는 것을 말씀드리고 넘어가고자 해요. 
대표적인 웹 브라우저에는 크롬 파이어폭스 사파리 등이 있지요.
크롬은 블링크,
파이어 폭스는 게코,
사파리는 웹킷 엔진을 사용 합니다.

크롬도 예전에는 웹킷일라는 엔진을 사용하다가 
2013년에 웹킷에서 갈라져 나온 블링크 라는 엔진을 사용하고 있습니다.

모든 렌더링 엔진이 기본적으로 웹 표준을 준수하면서도
엔진마다 조금씩 다르게 동작하는 부분도 있다고 해요.
그래서 용어도 조금씩 다르다고 합니다. 
이 시간에는 저희가 많이 사용하고 있는 크롬을 기준으로 말씀드리고자 합니다. 



렌더링 엔진은 크게 두 가지 목표를 가지고 있다고 해요.
첫 번째로 웹페이지에 포함된 모든 요소들을 
화면에 보여준다는 것!

두 번째로 업데이트가 필요할 때 
효율적으로 렌더링을 할 수 있도록 
자료구조를 생성해야 된다는 것입니다.

여기서 지금 말씀드린 업데이트는 사용자 동작으로 인해
입력이 발생한다던가, 스크롤이 생겼다던가, 
에니메이션이 동작한다던가, 
비동기 요청으로 인한 데이터 로딩 등의 종류가 있습니다. 



이런 목표를 이루기 위해 렌더링 엔진은 크게 다음과 같이 동작합니다. 
돔트리, 씨에스에스옴 생성부터 
렌더트리 생성, 렌더트리 배치, 렌더트리 그리기 단계로 진행된다고 합니다.
이를 Critical Rendering Path라고 합니다. 

하나씩 알아보도록 하겠습니다. 



먼저 브라우저가 요청한 사용자 문서를 불러오고 파싱을 합니다. 
여기서 파싱은 토큰들의 집합을 구문 분석해서 
트리를 생성하는 것을 말합니다. 

제가 예시코드를 작성해보았습니다. 
이 코드는 어휘 분석을 통해 HTMl5 표준에 지정된 고유한 토큰으로 변환됩니다. 
예를 들어 StartTag body이라는 코드는 body태그가 열렸다는 의미를 가지고,
EndTag html는 html태그가 닫혔다는 의미를 가집니다. 



그리고 난 다음 브라우저의 토큰이 
해당 속성과 규칙을 정의하는 노드 객체로 변환 됩니다. 
이를 렉싱 과정이라고 합니다. 

그리고 각 노드가 서로 연관성을 가질 수 있도록 
트리를 생성하는데
이게 바로 DOM 트리입니다. 

HTML 문서의 모든 것들은 이 돔을 구성하게 되는데, 
먼저 최상위에는 document 객체가 들어가고, 
태그는 element 노드가 되고, 
태그의 요소는 attribute node 가 됩니다.
예를들어 이미지 테그 내에 src속성 등, 
텍스트의 경우 text node가 되어 트리구조로 생성됩니다.

이 외의 주석도 comment 노드가 되어 생성됩니다.
브라우저는 HTML 문서를 파싱하는 과정에서 자바스크립트나 css 같이 추가로 필요한 파일들을 불러오도록 요청한다고 합니다. 



HTML을 돔트리로 만드는 과정과 비슷하게, CSS로는 CSSOM트리가 만들어집니다. 
CSSOM은 돔이 어떻게 화면에 표시될 지를 알려주는 역할을 합니다.
CSS도 위에서 아래로 스타일 규칙이 정해지기 떄문에 이 또한 트리구조를 가지고 있습니다. 
예를들어 스타일 시트에서  p태그에 text-align 속성을 정해뒀다면, p에 자식요소들에게도 동일한 속성이 전파되서 적용되게 됩니다. 



그리고 렌더링 엔진이 돔트리와 씨에스에스옴 트리를 합쳐서 렌더트리라는 것을 만들게 됩니다. 
렌더트리는 화면에 표시되어야 할 모든 노드의 컨텐츠, 스타일 정보를 포함하고 있는 트리입니다. 
먼저 렌더 트리가 만들어지는 과정을 대략적으로 설명을 드리자면, document 객체부터 각 노드를 순회하면서 각각의 맞는 cssom 을 찾아서 규칙을 적용합니다.
그러면서 렌더와 관련된 요소들을 렌더트리에 포함시키게 됩니다. 
이때 메타 태그나 디스플레이 논 속성을 가진 요소들은 렌더와 관계가 없기 때문에 렌더트리에 포함되지 않습니다.
여기서 제가 보여드린 렌더 트리 그림은 많이 간소화 되어 있습니다. 렌더 트리가 실제로는 더 많은 데이터를 가지고 있고, 브라우저마다 조금씩 다르게 생성된다는 것을 참고해주시면 좋겠습니다. 



렌더트리가 생성이 되었다면, 레이아웃이라는 과정을 거칩니다.
Reflow라고도 부릅니다. 
뷰포트 내에서 요소들의 정확한 위치와 크기를 계산하는 과정입니다. 
박스모델에 따라서 텍스트나 요소의 박스가 
화면에서 차지하는 영역이나 여백, 이외의 스타일 속성이 계산됩니다. 
이때 CSS에서 %, em 같은 상대적인 단위를 사용했을 때는 기계의 뷰포트에 맞춰서 픽셀단위로 변환됩니다.
레이아웃 과정에서 렌더링 엔진이 각 요소들이 어떻게 생겼고 이를 어떻게 보여줄지 알게 되면,



화면의 실제 픽셀로 그려지도록 변환하는 과정을 거치는데 이것이 바로 페인트 과정입니다. 이 과정에서 렌더 트리에 포함된 요소들이나 텍스트 이미지들이 실제 픽셀로 그려집니다.



Critical rendering path의 시간을 줄이면 브라우저가 웹페이지를 보여주는 데 걸리는 시간도 줄일 수 있습니다. 

하지만 사용자 동작으로 인해 자바스크립트가 실행되어 css가 변경되거나 에니메이션이 발생했을 때는 어떻게 되는 지 같이 알아보겠습니다. 



3가지 경우로 발생이 되는데, 

첫 번째로 레이아웃이 다시 발생하는 경우 입니다.
보통 요소의 크기나 위치가 바뀔 때 아니면 브라우저창이 크기가 바뀌었을 때 그림의 순서에 따라서 레이아웃이 다시 발생합니다. 
이때 레이아웃 수치를 다시 계산해서 배치를 해야되기 때문에 레이아웃 과정이 다시 발생하고, 
이에 맞춰서 다시 페인트도 해주어야 하고 
레이어 합성하는 과정까지 거쳐야 합니다. 



두 번째로 페인트부터 다시 발생되는 경우 입니다.
배경이미지나 텍스트 색상, 그림자 등 레이아웃 수치를 변화시키지 않는 스타일의 변경이 일어났을 때 발생합니다. 
이와 같은 경우는 레이아웃 과정이 이루어지지 않기 때문에 성능상으로 좀 더 이점을 가지겠지요.



마지막으로 레이아웃의 합성만 다시 발생하는 경우입니다. 
레이어는 포토샵의 레이어와 비슷하게 페인팅할 영역을 나누어 놓는 것을 의미합니다. 

크롬의 경우에는 레이아웃 과정 이후에 정해진 기준이나 필요에 의해서 브라우저가 레이어를 생성합니다. 
그리고 렌더 트리에 있는 노드 객체들은 생성된 레이어에 포함되게 됩니다. 레이어들은 트리 형태로 구성이 된다고 해요. 

그리고 렌더링 엔진이 각 레이어를 페인팅 과정에서 각각 그려준 다음에 하나의 비트맵으로 합성해서 페이지를 완성합니다. 


이 처럼 UI가 업데이트 되는 상황을 3가지로 말씀드렸는데요.
이렇게 말씀드리고, 실제로 어떻게 확인하면 좋을지에 대해서도 말씀드리고자 준비했습니다.
css 속성별로 렌더링 과정을 확인 할 수 있는 사이트가 있어 소개해드리고자 합니다.
(css trigger)



마지막으로 렌더링을 확인하실 수 있는 방법을 말씀드리겠습니다. 
개발자 도구 -> 퍼포먼스 탭
브라우저가 런타임에서 언제 어떤 처리를 하는 지 확인할 수 있는 도구입니다. 
(브라우저 예시)






